#!/usr/bin/env bash
# tvault — Token Vault agent CLI
# Retrieve credentials from Token Vault for use in scripts and agent pipelines.
#
# Install:
#   curl -fsSL https://raw.githubusercontent.com/c-lgrant/tvault/main/tvault -o /usr/local/bin/tvault && chmod +x /usr/local/bin/tvault
#
# Setup:
#   tvault init
#
# Usage:
#   tvault github                      Print the access token for "github"
#   tvault <service>                   Print the access token for any granted service
#   tvault                             List all granted services
#   tvault init                        Save your agent key (interactive)
#   tvault init --key <key>            Save your agent key (non-interactive)
#   tvault install-skill               Install /tvault slash command for Claude Code
#   tvault update                      Update tvault CLI to the latest version
#   tvault version                     Print version
#   tvault --help                      Show this help
#
# Examples:
#
#   GitHub API:
#     curl -H "Authorization: token $(tvault github)" https://api.github.com/user
#     gh auth login --with-token <<< "$(tvault github)"
#
#   Google Gemini:
#     curl "https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent?key=$(tvault gemini)" \
#       -H "Content-Type: application/json" \
#       -d '{"contents":[{"parts":[{"text":"Hello"}]}]}'
#
#   Anthropic Claude:
#     curl https://api.anthropic.com/v1/messages \
#       -H "x-api-key: $(tvault anthropic)" \
#       -H "anthropic-version: 2023-06-01" \
#       -H "content-type: application/json" \
#       -d '{"model":"claude-sonnet-4-20250514","max_tokens":1024,"messages":[{"role":"user","content":"Hello"}]}'
#
#   OpenAI:
#     curl https://api.openai.com/v1/chat/completions \
#       -H "Authorization: Bearer $(tvault openai)" \
#       -H "Content-Type: application/json" \
#       -d '{"model":"gpt-4o","messages":[{"role":"user","content":"Hello"}]}'
#
#   Environment variables:
#     export GITHUB_TOKEN=$(tvault github)
#     export ANTHROPIC_API_KEY=$(tvault anthropic)
#     export OPENAI_API_KEY=$(tvault openai)
#
#   Pipe to clipboard:
#     tvault github | pbcopy          # macOS
#     tvault github | xclip -sel c    # Linux

set -euo pipefail

TV_VERSION="0.3.0"
TV_DEFAULT_API_URL="https://api.tokenvault.uk"
TV_CONFIG_DIR="${TV_CONFIG_DIR:-${XDG_CONFIG_HOME:-$HOME/.config}/tv}"
TV_CONFIG_FILE="${TV_CONFIG_DIR}/config"

# ── Config ───────────────────────────────────────────────────────────────────

load_config() {
  if [[ -f "$TV_CONFIG_FILE" ]]; then
    # shellcheck source=/dev/null
    source "$TV_CONFIG_FILE"
  fi
  # Env vars override config file
  TV_AGENT_KEY="${TV_AGENT_KEY:-${tv_agent_key:-}}"
  TV_API_URL="${TV_API_URL:-${tv_api_url:-$TV_DEFAULT_API_URL}}"
}

# ── Help ─────────────────────────────────────────────────────────────────────

show_help() {
  sed -n '2,/^$/{ s/^# \?//; p }' "$0"
  exit 0
}

# ── Init ─────────────────────────────────────────────────────────────────────

do_init() {
  shift  # remove "init"
  local key=""

  # Parse flags
  while [[ $# -gt 0 ]]; do
    case "$1" in
      --key)
        key="$2"
        shift 2
        ;;
      *)
        echo "tvault init: unknown option: $1" >&2
        exit 1
        ;;
    esac
  done

  echo "Token Vault CLI Setup"
  echo ""

  # Read agent key interactively if not provided via --key
  if [[ -z "$key" ]]; then
    printf "Agent key (tvagent_...): "
    read -r key
  fi
  if [[ -z "$key" ]]; then
    echo "tvault: error: agent key cannot be empty" >&2
    exit 1
  fi
  if [[ "$key" != tvagent_* ]]; then
    echo "tvault: error: agent key must start with tvagent_" >&2
    exit 1
  fi

  # Verify key works
  printf "Verifying key... "
  resp=$(curl -sS -w "\n%{http_code}" \
    -H "Authorization: Bearer ${key}" \
    -H "Accept: application/json" \
    "${TV_DEFAULT_API_URL}/api/agents/credentials" 2>&1) || {
      echo "failed"
      echo "tvault: error: could not connect to ${TV_DEFAULT_API_URL}" >&2
      exit 1
    }
  http_code=$(echo "$resp" | tail -1)
  if [[ "$http_code" -eq 401 || "$http_code" -eq 403 ]]; then
    echo "failed"
    echo "tvault: error: invalid agent key" >&2
    exit 1
  fi
  echo "ok"

  # Write config
  mkdir -p "$TV_CONFIG_DIR"
  cat > "$TV_CONFIG_FILE" <<CONF
# Token Vault CLI config — generated by tvault init
tv_agent_key="${key}"
CONF
  chmod 600 "$TV_CONFIG_FILE"

  # Show grants
  body=$(echo "$resp" | sed '$d')
  grants=$(echo "$body" | python3 -c "
import sys, json
for g in json.load(sys.stdin).get('grants', []):
    print(f'  {g[\"serviceName\"]}')
" 2>/dev/null || true)

  echo ""
  echo "Saved to ${TV_CONFIG_FILE}"
  if [[ -n "$grants" ]]; then
    echo ""
    echo "Available tokens:"
    echo "$grants"
  fi
  echo ""
  echo "Usage: tvault github"
}

# ── Update ──────────────────────────────────────────────────────────────────

TV_RELEASE_URL="https://raw.githubusercontent.com/c-lgrant/tvault/main/tvault"

do_update() {
  local self
  self=$(realpath "$0" 2>/dev/null || readlink -f "$0" 2>/dev/null || echo "$0")

  # Check we can write to the current location
  if [[ ! -w "$self" ]]; then
    echo "tvault: error: no write permission to ${self}" >&2
    echo "Try: sudo tvault update" >&2
    exit 1
  fi

  printf "Checking for updates... "

  # Fetch remote version line
  local remote_version
  remote_version=$(curl -fsSL "${TV_RELEASE_URL}" 2>/dev/null \
    | grep -m1 '^TV_VERSION=' | cut -d'"' -f2) || {
    echo "failed"
    echo "tvault: error: could not reach update server" >&2
    exit 1
  }

  if [[ -z "$remote_version" ]]; then
    echo "failed"
    echo "tvault: error: could not parse remote version" >&2
    exit 1
  fi

  if [[ "$remote_version" == "$TV_VERSION" ]]; then
    echo "already up to date (v${TV_VERSION})"
    exit 0
  fi

  echo "v${TV_VERSION} -> v${remote_version}"

  # Download to temp file, then atomic swap
  local tmp
  tmp=$(mktemp)
  if curl -fsSL "${TV_RELEASE_URL}" -o "$tmp" 2>/dev/null; then
    chmod +x "$tmp"
    mv "$tmp" "$self"
    echo "Updated to v${remote_version}"
  else
    rm -f "$tmp"
    echo "tvault: error: download failed" >&2
    exit 1
  fi
}

# ── Install Skill ────────────────────────────────────────────────────────────

TV_SKILL_REPO_URL="https://raw.githubusercontent.com/c-lgrant/tvault/main"

do_install_skill() {
  shift  # remove "install-skill"
  local scope=""

  # Parse flags
  while [[ $# -gt 0 ]]; do
    case "$1" in
      --repo)  scope="repo";  shift ;;
      --user)  scope="user";  shift ;;
      *)
        echo "tvault install-skill: unknown option: $1" >&2
        echo "Usage: tvault install-skill [--repo | --user]" >&2
        exit 1
        ;;
    esac
  done

  echo "Token Vault — Claude Code Integration"
  echo ""

  # Prompt for scope if not given via flag
  if [[ -z "$scope" ]]; then
    echo "Where should the /tvault skill be installed?"
    echo ""
    echo "  1) user   ~/.claude/skills/tvault/       (available in all projects)"
    echo "  2) repo   .claude/skills/tvault/          (committed to this repo)"
    echo ""
    printf "Choice [1]: "
    read -r choice
    case "${choice:-1}" in
      1|user)  scope="user" ;;
      2|repo)  scope="repo" ;;
      *)
        echo "tvault: invalid choice: $choice" >&2
        exit 1
        ;;
    esac
  fi

  # Resolve target directory
  if [[ "$scope" == "repo" ]]; then
    # Find repo root
    local repo_root
    repo_root=$(git rev-parse --show-toplevel 2>/dev/null) || {
      echo "tvault: error: not inside a git repository. Use --user instead." >&2
      exit 1
    }
    local skill_dir="${repo_root}/.claude/skills/tvault"
    echo ""
    echo "Installing to repo: ${repo_root}"
  else
    local skill_dir="${HOME}/.claude/skills/tvault"
    echo ""
    echo "Installing to user: ~/.claude/"
  fi

  # Fetch and install SKILL.md
  printf "Fetching skill definition... "
  mkdir -p "$skill_dir"
  if curl -fsSL "${TV_SKILL_REPO_URL}/SKILL.md" -o "${skill_dir}/SKILL.md" 2>/dev/null; then
    echo "ok"
  else
    echo "failed"
    echo "tvault: error: could not download SKILL.md" >&2
    exit 1
  fi

  echo ""
  echo "Installed:"
  echo "  Skill: ${skill_dir}/SKILL.md"
  echo ""
  echo "Available in Claude Code:"
  echo "  /tvault github    Retrieve a token via slash command"
  echo "  /tvault           List available grants"

  # Remind about agent key if not configured
  if [[ ! -f "$TV_CONFIG_FILE" ]] && [[ -z "${TV_AGENT_KEY:-}" ]]; then
    echo ""
    echo "Note: Run 'tvault init' to configure your agent key first."
  fi
}

# ── Main ─────────────────────────────────────────────────────────────────────

if [[ "${1:-}" == "--help" || "${1:-}" == "-h" ]]; then
  show_help
fi

if [[ "${1:-}" == "init" ]]; then
  do_init "$@"
  exit 0
fi

if [[ "${1:-}" == "install-skill" ]]; then
  do_install_skill "$@"
  exit 0
fi

if [[ "${1:-}" == "update" ]]; then
  do_update
  exit 0
fi

if [[ "${1:-}" == "version" || "${1:-}" == "--version" || "${1:-}" == "-v" ]]; then
  echo "tvault ${TV_VERSION}"
  exit 0
fi

load_config

# Parse global flags
while [[ $# -gt 0 ]]; do
  case "$1" in
    --api-url)
      TV_API_URL="$2"
      shift 2
      ;;
    --key)
      TV_AGENT_KEY="$2"
      shift 2
      ;;
    *)
      break
      ;;
  esac
done

if [[ -z "${TV_AGENT_KEY:-}" ]]; then
  echo "tvault: not configured. Run: tvault init" >&2
  exit 1
fi

# ── API call ─────────────────────────────────────────────────────────────────

service="${1:-}"

if [[ -n "$service" ]]; then
  url="${TV_API_URL}/api/agents/credentials?service=${service}"
else
  url="${TV_API_URL}/api/agents/credentials"
fi

response=$(curl -sS -w "\n%{http_code}" \
  -H "Authorization: Bearer ${TV_AGENT_KEY}" \
  -H "Accept: application/json" \
  "$url" 2>&1) || {
    echo "tvault: error: failed to connect to ${TV_API_URL}" >&2
    exit 1
  }

http_code=$(echo "$response" | tail -1)
body=$(echo "$response" | sed '$d')

# ── Response handling ────────────────────────────────────────────────────────

if [[ "$http_code" -ge 200 && "$http_code" -lt 300 ]]; then
  if [[ -n "$service" ]]; then
    # Single token — print just the access token (clean for piping)
    echo "$body" | python3 -c "import sys,json; print(json.load(sys.stdin)['accessToken'])" 2>/dev/null \
      || echo "$body" | jq -r '.accessToken' 2>/dev/null \
      || { echo "tvault: error: unexpected response format" >&2; echo "$body" >&2; exit 1; }
  else
    # List mode — print service names, one per line
    echo "$body" | python3 -c "
import sys, json
grants = json.load(sys.stdin).get('grants', [])
for g in grants:
    name = g['serviceName']
    expires = g.get('grantExpiresAt', '')
    suffix = f'  (expires {expires})' if expires else ''
    print(f'{name}{suffix}')
if not grants:
    print('No grants available.', file=sys.stderr)
" 2>/dev/null || {
      echo "$body" | jq -r '.grants[].serviceName' 2>/dev/null \
        || { echo "tvault: error: unexpected response format" >&2; echo "$body" >&2; exit 1; }
    }
  fi
else
  # Error — extract message and print to stderr
  msg=$(echo "$body" | python3 -c "import sys,json; d=json.load(sys.stdin); print(d.get('detail') or d.get('error') or d.get('message','Unknown error'))" 2>/dev/null \
    || echo "$body" | jq -r '.detail // .error // .message // "Unknown error"' 2>/dev/null \
    || echo "$body")
  echo "tvault: error ($http_code): $msg" >&2
  exit 1
fi
